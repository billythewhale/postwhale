<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SSE Test - Moby Service</title>
  <style>
    body {
      font-family: 'Monaco', 'Courier New', monospace;
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }

    h1 {
      color: #4ec9b0;
    }

    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    .panel {
      background: #252526;
      border: 1px solid #3e3e42;
      border-radius: 6px;
      padding: 20px;
    }

    .panel h2 {
      margin-top: 0;
      color: #4ec9b0;
      font-size: 18px;
    }

    input,
    textarea,
    button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      background: #3c3c3c;
      border: 1px solid #555;
      color: #d4d4d4;
      font-family: inherit;
      border-radius: 4px;
    }

    button {
      cursor: pointer;
      background: #0e639c;
      color: white;
      font-weight: bold;
    }

    button:hover {
      background: #1177bb;
    }

    button:disabled {
      background: #555;
      cursor: not-allowed;
    }

    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-weight: bold;
    }

    .status.connected {
      background: #0d3a1f;
      color: #4ec9b0;
      border: 1px solid #4ec9b0;
    }

    .status.disconnected {
      background: #3a1d1d;
      color: #f48771;
      border: 1px solid #f48771;
    }

    #events {
      background: #1e1e1e;
      border: 1px solid #3e3e42;
      padding: 15px;
      height: 400px;
      overflow-y: auto;
      margin-top: 10px;
      font-size: 13px;
      line-height: 1.6;
    }

    .event {
      margin: 8px 0;
      padding: 8px;
      border-left: 3px solid #4ec9b0;
      background: #2d2d30;
    }

    .event-time {
      color: #858585;
      font-size: 11px;
    }

    .event-type {
      color: #dcdcaa;
      font-weight: bold;
    }

    .event-data {
      color: #ce9178;
      margin-top: 4px;
    }

    label {
      display: block;
      margin-top: 10px;
      color: #9cdcfe;
      font-size: 13px;
    }

    .buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .info {
      background: #1a3a52;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-size: 13px;
      border: 1px solid #264f78;
    }
  </style>
</head>

<body>
  <h1>üöÄ Moby SSE Streaming Test</h1>

  <div class="info">
    <strong>Instructions:</strong>
    1. Enter a session ID and click "Connect to SSE Stream" 2. Send test messages using the
    publish form 3. Watch events appear in real-time!
  </div>

  <div class="container">
    <!-- Left Panel: SSE Connection -->
    <div class="panel">
      <h2>üì° SSE Stream</h2>

      <label>Session ID:</label>
      <input type="text" id="sessionId" value="test-session-123" placeholder="Enter session ID" />

      <div class="buttons">
        <button id="connectBtn" onclick="connect()">Connect</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
      </div>

      <div id="status" class="status disconnected">‚ö´ Disconnected</div>

      <button onclick="clearEvents()">Clear Events</button>

      <div id="events"></div>
    </div>

    <!-- Right Panel: Publish Messages -->
    <div class="panel">
      <h2>üì§ Publish Test Messages</h2>

      <label>Session ID:</label>
      <input type="text" id="publishSessionId" value="test-session-123" />

      <label>Conversation ID:</label>
      <input type="text" id="conversationId" value="test-conv-456" />

      <label>Event Type:</label>
      <select id="eventType" style="
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: #3c3c3c;
            border: 1px solid #555;
            color: #d4d4d4;
          ">
        <option value="text_chunk">text_chunk</option>
        <option value="reasoning_chunk">reasoning_chunk</option>
        <option value="tool_call_started">tool_call_started</option>
        <option value="tool_call_completed">tool_call_completed</option>
        <option value="tool_call_failed">tool_call_failed</option>
        <option value="chat_done">chat_done</option>
      </select>

      <label>Data (JSON):</label>
      <textarea id="eventData" rows="8">{"content": "Hello from browser!", "index": 0}</textarea>

      <button onclick="publishMessage()">Send Message</button>

      <div style="margin-top: 20px">
        <strong style="color: #4ec9b0">Quick Actions:</strong>
        <button onclick="sendTextChunk()">Send Text Chunk</button>
        <button onclick="sendToolStarted()">Send Tool Started</button>
        <button onclick="sendToolCompleted()">Send Tool Completed</button>
        <button onclick="sendChatDone()">Send Chat Done</button>
      </div>
    </div>
  </div>

  <script>
    let eventSource = null;
    let eventCount = 0;

    function connect() {
      const sessionId = document.getElementById('sessionId').value;
      if (!sessionId) {
        alert('Please enter a session ID');
        return;
      }

      if (eventSource) {
        eventSource.close();
      }

      eventSource = new EventSource(`http://localhost/moby/stream/${sessionId}`);

      eventSource.onopen = () => {
        updateStatus(true);
        addLog('system', '‚úÖ SSE connection opened');
      };

      eventSource.onerror = (error) => {
        console.error('SSE error:', error);
        addLog('error', '‚ùå SSE connection error');
        updateStatus(false);
      };

      eventSource.addEventListener('connected', (e) => {
        const data = JSON.parse(e.data);
        addEvent('connected', data);
      });

      eventSource.addEventListener('text_chunk', (e) => {
        const data = JSON.parse(e.data);
        addEvent('text_chunk', data);
      });

      eventSource.addEventListener('reasoning_chunk', (e) => {
        const data = JSON.parse(e.data);
        addEvent('reasoning_chunk', data);
      });

      eventSource.addEventListener('tool_call_started', (e) => {
        const data = JSON.parse(e.data);
        addEvent('tool_call_started', data);
      });

      eventSource.addEventListener('tool_call_completed', (e) => {
        const data = JSON.parse(e.data);
        addEvent('tool_call_completed', data);
      });

      eventSource.addEventListener('tool_call_failed', (e) => {
        const data = JSON.parse(e.data);
        addEvent('tool_call_failed', data);
      });

      eventSource.addEventListener('chat_done', (e) => {
        const data = JSON.parse(e.data);
        addEvent('chat_done', data);
      });

      eventSource.onmessage = (e) => {
        console.log('Unhandled message:', e);
      };
    }

    function disconnect() {
      if (eventSource) {
        eventSource.close();
        eventSource = null;
        updateStatus(false);
        addLog('system', 'üîå Disconnected');
      }
    }

    function updateStatus(connected) {
      const status = document.getElementById('status');
      const connectBtn = document.getElementById('connectBtn');
      const disconnectBtn = document.getElementById('disconnectBtn');

      if (connected) {
        status.textContent = 'üü¢ Connected';
        status.className = 'status connected';
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;
      } else {
        status.textContent = '‚ö´ Disconnected';
        status.className = 'status disconnected';
        connectBtn.disabled = false;
        disconnectBtn.disabled = true;
      }
    }

    function addEvent(type, data) {
      eventCount++;
      const events = document.getElementById('events');
      const time = new Date().toLocaleTimeString();

      const eventDiv = document.createElement('div');
      eventDiv.className = 'event';
      eventDiv.innerHTML = `
                <div class="event-time">#${eventCount} - ${time}</div>
                <div class="event-type">üì® ${type}</div>
                <div class="event-data">${JSON.stringify(data, null, 2)}</div>
            `;

      events.appendChild(eventDiv);
      events.scrollTop = events.scrollHeight;
    }

    function addLog(type, message) {
      const events = document.getElementById('events');
      const time = new Date().toLocaleTimeString();

      const logDiv = document.createElement('div');
      logDiv.style.padding = '5px';
      logDiv.style.color = type === 'error' ? '#f48771' : '#858585';
      logDiv.style.fontSize = '12px';
      logDiv.textContent = `[${time}] ${message}`;

      events.appendChild(logDiv);
      events.scrollTop = events.scrollHeight;
    }

    async function publishMessage() {
      const sessionId = document.getElementById('publishSessionId').value;
      const conversationId = document.getElementById('conversationId').value;
      const eventType = document.getElementById('eventType').value;
      const dataText = document.getElementById('eventData').value;

      try {
        const data = JSON.parse(dataText);

        const response = await fetch('http://localhost/moby/test/publish', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            sessionId,
            conversationId,
            eventType,
            data,
          }),
        });

        const result = await response.json();
        console.log('Publish result:', result);

        if (result.success) {
          addLog('system', `‚úÖ Published ${eventType} (messageId: ${result.messageId})`);
        } else {
          addLog('error', `‚ùå Publish failed: ${result.error}`);
        }
      } catch (error) {
        console.error('Error:', error);
        addLog('error', `‚ùå Error: ${error.message}`);
        alert('Error publishing message: ' + error.message);
      }
    }

    function sendTextChunk() {
      document.getElementById('eventType').value = 'text_chunk';
      document.getElementById('eventData').value = JSON.stringify(
        {
          content: 'This is a text chunk from the LLM response.',
          index: 0,
        },
        null,
        2,
      );
      publishMessage();
    }

    function sendToolStarted() {
      document.getElementById('eventType').value = 'tool_call_started';
      document.getElementById('eventData').value = JSON.stringify(
        {
          toolName: 'TextToSQL',
          parameters: {
            question: 'What were my sales yesterday?',
          },
        },
        null,
        2,
      );
      publishMessage();
    }

    function sendToolCompleted() {
      document.getElementById('eventType').value = 'tool_call_completed';
      document.getElementById('eventData').value = JSON.stringify(
        {
          toolName: 'TextToSQL',
          result: {
            query: 'SELECT SUM(revenue) FROM orders',
            total: 15420.5,
          },
        },
        null,
        2,
      );
      publishMessage();
    }

    function sendChatDone() {
      document.getElementById('eventType').value = 'chat_done';
      document.getElementById('eventData').value = JSON.stringify(
        {
          message: 'Chat completed successfully',
        },
        null,
        2,
      );
      publishMessage();
    }

    function clearEvents() {
      eventCount = 0;
      document.getElementById('events').innerHTML = '';
    }
  </script>
</body>

</html>
